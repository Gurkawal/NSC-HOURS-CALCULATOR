<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    h1 { color: #333; }
    label, input { display: block; margin: 5px 0; }
    input[type="text"] { padding: 5px; width: 150px; }
    button { margin: 10px 5px 0 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #ddd; }
    .delete-btn { background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>

<h1>NSC Service Hours Calculator</h1>
<form id="nscForm">
  <label>Shift 1 Start (e.g., 0500): <input type="text" id="shift1Start"></label>
  <label>Shift 1 End (e.g., 1300): <input type="text" id="shift1End"></label>
  <label>Shift 2 Start (optional): <input type="text" id="shift2Start"></label>
  <label>Shift 2 End (optional): <input type="text" id="shift2End"></label>
  <label>Overtime Before Shift 1 (optional): <input type="text" id="otBefore"></label>
  <label>Overtime Between Shifts (optional): <input type="text" id="otBetween"></label>
  <label>Overtime After Shift 2 (optional): <input type="text" id="otAfter"></label>
  <button type="submit">Submit Day</button>
  <button type="button" onclick="downloadPDF()">Download PDF</button>
</form>

<table id="results">
  <thead>
    <tr>
      <th>Day</th>
      <th>Shift 1</th>
      <th>Shift 2</th>
      <th>Split Hours</th>
      <th>Overtime (Before / Between / After)</th>
      <th>Total Duty</th>
      <th>TET</th>
      <th>Off-Duty</th>
      <th>NSC Violation</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
  const form = document.getElementById('nscForm');
  const tbody = document.querySelector('#results tbody');
  let logs = [];
  let lastShiftEnd = null;

  function timeToMinutes(timeStr) {
    if (!timeStr) return null;
    let time = parseInt(timeStr);
    let hour = Math.floor(time / 100);
    let minutes = time % 100;
    return hour * 60 + minutes;
  }

  function minutesToHours(mins) {
    return (mins / 60).toFixed(2);
  }

  function duration(start, end) {
    if (!start || !end) return 0;
    let s = timeToMinutes(start);
    let e = timeToMinutes(end);
    if (e < s) e += 1440;
    return e - s;
  }

  function renderTable() {
    tbody.innerHTML = "";
    logs.forEach((log, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${log.s1s || "-"} to ${log.s1e || "-"} (${minutesToHours(log.shift1Mins)}h)</td>
          <td>${log.s2s && log.s2e ? `${log.s2s} to ${log.s2e} (${minutesToHours(log.shift2Mins)}h)` : "-"}</td>
          <td>${minutesToHours(log.splitMins)}h</td>
          <td>${minutesToHours(log.otBefore)} / ${minutesToHours(log.otBetween)} / ${minutesToHours(log.otAfter)} h</td>
          <td>${minutesToHours(log.totalDutyMins)}h</td>
          <td>${minutesToHours(log.tet)}h</td>
          <td>${minutesToHours(log.offDuty)}h</td>
          <td>${log.violation.length ? log.violation.join(", ") : "None"}</td>
          <td><button class="delete-btn" onclick="deleteRow(${index})">Delete</button></td>
        </tr>
      `;
    });
  }

  function deleteRow(index) {
    logs.splice(index, 1);
    renderTable();
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    let s1s = document.getElementById('shift1Start').value;
    let s1e = document.getElementById('shift1End').value;
    let s2s = document.getElementById('shift2Start').value;
    let s2e = document.getElementById('shift2End').value;
    let ot1 = document.getElementById('otBefore').value;
    let ot2 = document.getElementById('otBetween').value;
    let ot3 = document.getElementById('otAfter').value;

    let shift1Mins = duration(s1s, s1e);
    let shift2Mins = s2s && s2e ? duration(s2s, s2e) : 0;
    let splitMins = s2s ? duration(s1e, s2s) : 0;

    let otBefore = ot1 && s1s ? duration(ot1, s1s) : 0;
    let otBetween = s1e && ot2 ? duration(s1e, ot2) : 0;
    let otAfter = (s2e || s1e) && ot3 ? duration(s2e || s1e, ot3) : 0;

    let totalDutyMins = shift1Mins + shift2Mins + otBefore + otBetween + otAfter;
    let tet = s2e ? duration(s1s, s2e) : shift1Mins;

    let startOfDay = timeToMinutes(s1s);
    let offDuty = 1440;
    if (lastShiftEnd !== null) {
      if (startOfDay < lastShiftEnd) startOfDay += 1440;
      offDuty = startOfDay - lastShiftEnd;
    }

    lastShiftEnd = timeToMinutes(s2e || s1e);

    let violation = [];
    if (totalDutyMins / 60 > 14) violation.push("Duty >14h");
    if (tet / 60 > 16) violation.push("TET >16h");
    if (offDuty < 480) violation.push("Off-duty <8h");

    logs.push({
      s1s, s1e, s2s, s2e,
      shift1Mins, shift2Mins,
      splitMins, otBefore, otBetween, otAfter,
      totalDutyMins, tet, offDuty, violation
    });

    form.reset();
    renderTable();
  });

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const table = document.getElementById("results");
    const canvas = await html2canvas(table);
    const imgData = canvas.toDataURL("image/png");
    const imgProps = doc.getImageProperties(imgData);
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    doc.text("NSC Service Hours Log", 10, 10);
    doc.addImage(imgData, "PNG", 10, 20, pdfWidth - 20, pdfHeight);
    doc.save("NSC_Service_Hours.pdf");
  }
</script>

</body>
</html>
