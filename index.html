<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    h1 { color: #333; }
    label, input { display: block; margin: 5px 0; }
    input[type="text"] { padding: 5px; width: 150px; }
    button { margin-top: 10px; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #ddd; }
    .delete-btn { background-color: red; color: white; padding: 5px 10px; cursor: pointer; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>NSC Service Hours Calculator</h1>
  <form id="nscForm">
    <label>Shift 1 Start (e.g., 0500): <input type="text" id="shift1Start"></label>
    <label>Shift 1 End (e.g., 1300): <input type="text" id="shift1End"></label>
    <label>Shift 2 Start (optional): <input type="text" id="shift2Start"></label>
    <label>Shift 2 End (optional): <input type="text" id="shift2End"></label>
    <label>Overtime Before Shift 1 (optional): <input type="text" id="otBefore"></label>
    <label>Overtime Between Shifts (optional): <input type="text" id="otBetween"></label>
    <label>Overtime After Shift 2 (optional): <input type="text" id="otAfter"></label>
    <button type="submit">Submit Day</button>
  </form>
  <button onclick="downloadPDF()">Download PDF</button>  <table id="results">
    <thead>
      <tr>
        <th>Day</th>
        <th>Shift 1</th>
        <th>Shift 2</th>
        <th>Split Hours</th>
        <th>Overtime (Before/Between/After)</th>
        <th>Total Duty</th>
        <th>TET</th>
        <th>Off-Duty</th>
        <th>NSC Violation</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>  <script>
    const form = document.getElementById("nscForm");
    const tbody = document.querySelector("#results tbody");
    let entries = [];
    let lastEnd = null;
    let totalOffDuty = 0;
    let rolling7 = [];

    const timeToMinutes = time => {
      if (!time) return null;
      let t = parseInt(time);
      let h = Math.floor(t / 100), m = t % 100;
      return h * 60 + m;
    };

    const minutesToHours = min => (min / 60).toFixed(2);
    const duration = (start, end) => {
      let s = timeToMinutes(start), e = timeToMinutes(end);
      if (s == null || e == null) return 0;
      if (e < s) e += 1440;
      return e - s;
    };

    form.addEventListener("submit", function(e) {
      e.preventDefault();

      const s1s = form.shift1Start.value.trim();
      const s1e = form.shift1End.value.trim();
      const s2s = form.shift2Start.value.trim();
      const s2e = form.shift2End.value.trim();
      const ot1 = form.otBefore.value.trim();
      const ot2 = form.otBetween.value.trim();
      const ot3 = form.otAfter.value.trim();

      const shift1M = duration(s1s, s1e);
      const shift2M = s2s && s2e ? duration(s2s, s2e) : 0;
      const splitM = s2s ? duration(s1e, s2s) : 0;
      const otBM = ot1 && s1s ? duration(ot1, s1s) : 0;
      const otBtM = s1e && ot2 ? duration(s1e, ot2) : 0;
      const otAM = (s2e || s1e) && ot3 ? duration(s2e || s1e, ot3) : 0;
      const otTotal = otBM + otBtM + otAM;
      const dutyM = shift1M + shift2M + otTotal;
      const tet = s2e ? duration(s1s, s2e) : shift1M;

      let offDuty = 1440;
      if (lastEnd !== null) {
        let nextStart = timeToMinutes(s1s);
        if (nextStart < lastEnd) nextStart += 1440;
        offDuty = nextStart - lastEnd;
        totalOffDuty += offDuty;
      }

      if (totalOffDuty >= 2160) {
        rolling7 = [];
        totalOffDuty = 0;
      }

      lastEnd = timeToMinutes(s2e || s1e);
      rolling7.push(dutyM / 60);
      if (rolling7.length > 7) rolling7.shift();

      const day = entries.length + 1;
      let violations = [];
      if (dutyM / 60 > 14) violations.push(">14h Duty");
      if (tet / 60 > 16) violations.push("TET >16h");
      if (offDuty < 480) violations.push("<8h Off-Duty");
      if (rolling7.reduce((a,b)=>a+b,0) > 70) violations.push(">70h/7d");

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${day}</td>
        <td>${s1s || '-'} to ${s1e || '-'} (${minutesToHours(shift1M)}h)</td>
        <td>${s2s && s2e ? `${s2s} to ${s2e} (${minutesToHours(shift2M)}h)` : "-"}</td>
        <td>${minutesToHours(splitM)}h</td>
        <td>${minutesToHours(otBM)} / ${minutesToHours(otBtM)} / ${minutesToHours(otAM)} h</td>
        <td>${minutesToHours(dutyM)}h</td>
        <td>${minutesToHours(tet)}h</td>
        <td>${minutesToHours(offDuty)}h</td>
        <td>${violations.length ? violations.join(", ") : "None"}</td>
        <td><button class="delete-btn" onclick="deleteEntry(${entries.length})">Delete</button></td>
      `;
      tbody.appendChild(row);
      entries.push({ row });
      form.reset();
    });

    function deleteEntry(index) {
      const entry = entries[index];
      if (!entry) return;
      entry.row.remove();
      entries.splice(index, 1);
      // Recalculate day numbers
      tbody.innerHTML = '';
      entries.forEach((e, i) => {
        const tds = e.row.querySelectorAll("td");
        tds[0].textContent = i + 1;
        tbody.appendChild(e.row);
      });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const table = document.getElementById("results");
      const canvas = await html2canvas(table);
      const imgData = canvas.toDataURL("image/png");
      const imgProps = doc.getImageProperties(imgData);
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      doc.text("NSC Service Hours Log", 10, 10);
      doc.addImage(imgData, "PNG", 10, 20, pdfWidth - 20, pdfHeight);
      doc.save("NSC_Service_Hours.pdf");
    }
  </script></body>
</html>
