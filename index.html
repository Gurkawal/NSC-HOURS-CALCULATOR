<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    button {
      margin-top: 15px;
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      font-size: 0.9em;
    }
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    @media print {
      button {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>NSC Service Hours Calculator</h2>

    <div class="form-grid">
      <div>
        <label for="date">Date:</label>
        <input type="date" id="date">
      </div>
      <div>
        <label>Shift 1 Start (e.g., 0500):</label>
        <input type="text" id="shift1Start">
      </div>
      <div>
        <label>Shift 1 End (e.g., 1300):</label>
        <input type="text" id="shift1End">
      </div>
      <div>
        <label>Shift 2 Start (optional):</label>
        <input type="text" id="shift2Start">
      </div>
      <div>
        <label>Shift 2 End (optional):</label>
        <input type="text" id="shift2End">
      </div>
      <div>
        <label>Overtime Before Shift 1:</label>
        <input type="text" id="otBefore">
      </div>
      <div>
        <label>Overtime Between Shifts:</label>
        <input type="text" id="otBetween">
      </div>
      <div>
        <label>Overtime After Shift 2:</label>
        <input type="text" id="otAfter">
      </div>
    </div>

    <button onclick="submitDay()">Submit Day</button>
    <button onclick="downloadPDF()">Download PDF</button>

    <table id="results">
      <thead>
        <tr>
          <th>Day</th>
          <th>Date</th>
          <th>Shift 1</th>
          <th>Shift 2</th>
          <th>Split Hours</th>
          <th>OT (B/Btwn/A)</th>
          <th>Total Duty</th>
          <th>Cumulative Duty</th>
          <th>TET</th>
          <th>Off-Duty</th>
          <th>Violation</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const entries = [];

    function parseTime(str) {
      if (!str) return null;
      const hour = parseInt(str.slice(0, 2), 10);
      const min = parseInt(str.slice(2), 10);
      return hour + min / 60;
    }

    function formatTime24To12(time24) {
      const hours = Math.floor(time24) % 24;
      const minutes = Math.round((time24 % 1) * 60);
      const suffix = hours >= 12 ? "PM" : "AM";
      const displayHour = ((hours + 11) % 12 + 1);
      return `${displayHour}:${minutes.toString().padStart(2, "0")} ${suffix}`;
    }

    function formatTimeRange(start, end) {
      if (start == null || end == null) return "-";
      const duration = (end >= start ? end - start : 24 + end - start);
      return `${formatTime24To12(start)} to ${formatTime24To12(end)} (${duration.toFixed(2)}h)`;
    }

    function submitDay() {
      const date = document.getElementById("date").value;
      const s1Start = parseTime(document.getElementById("shift1Start").value);
      const s1End = parseTime(document.getElementById("shift1End").value);
      const s2Start = parseTime(document.getElementById("shift2Start").value);
      const s2End = parseTime(document.getElementById("shift2End").value);
      const otBefore = parseFloat(document.getElementById("otBefore").value) || 0;
      const otBetween = parseFloat(document.getElementById("otBetween").value) || 0;
      const otAfter = parseFloat(document.getElementById("otAfter").value) || 0;

      const shift1Duration = (s1Start != null && s1End != null) ? ((s1End - s1Start + 24) % 24) : 0;
      const shift2Duration = (s2Start != null && s2End != null) ? ((s2End - s2Start + 24) % 24) : 0;
      const splitHours = (s1End != null && s2Start != null) ? ((s2Start - s1End + 24) % 24) : 0;
      const totalDuty = shift1Duration + shift2Duration + otBefore + otBetween + otAfter;
      const TET = shift1Duration + shift2Duration;
      const dayNumber = entries.length + 1;
      const endTime = s2End != null ? s2End : s1End;
      const startTime = s1Start != null ? s1Start : s2Start;

      let offDuty = 24;
      let violation = "None";

      if (entries.length > 0) {
        const prev = entries[entries.length - 1];
        const prevEnd = new Date(prev.date + "T00:00");
        prevEnd.setHours(Math.floor(prev.endTime));
        prevEnd.setMinutes(Math.round((prev.endTime % 1) * 60));

        const currStart = new Date(date + "T00:00");
        currStart.setHours(Math.floor(startTime));
        currStart.setMinutes(Math.round((startTime % 1) * 60));

        if (currStart <= prevEnd) currStart.setDate(currStart.getDate() + 1);

        const diff = (currStart - prevEnd) / (1000 * 60 * 60);
        offDuty = diff;

        if (offDuty < 8) violation = "Off-duty <8h";
      }

      if (totalDuty > 14) violation = "Over 14h duty";
      if (TET > 16) violation = "Over 16h TET";

      let cumulativeDuty = totalDuty;
      if (entries.length > 0) {
        cumulativeDuty += parseFloat(entries[entries.length - 1].cumulativeDuty);
      }

      entries.push({
        dayNumber,
        date,
        shift1: formatTimeRange(s1Start, s1End),
        shift2: formatTimeRange(s2Start, s2End),
        splitHours: splitHours.toFixed(2) + "h",
        overtime: `${otBefore.toFixed(2)} / ${otBetween.toFixed(2)} / ${otAfter.toFixed(2)} h`,
        totalDuty: totalDuty.toFixed(2) + "h",
        cumulativeDuty: cumulativeDuty.toFixed(2),
        TETRange: (() => {
          if (startTime == null) return "-";
          const endTET = (startTime + 16) % 24;
          return `${formatTime24To12(startTime)} to ${formatTime24To12(endTET)} (16.00h)`;
        })(),
        offDuty: offDuty.toFixed(2) + "h",
        violation,
        endTime
      });

      renderTable();
      clearInputs();
    }

    function renderTable() {
      const tbody = document.querySelector("#results tbody");
      tbody.innerHTML = "";
      entries.forEach((entry, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.dayNumber}</td>
          <td>${entry.date}</td>
          <td>${entry.shift1}</td>
          <td>${entry.shift2}</td>
          <td>${entry.splitHours}</td>
          <td>${entry.overtime}</td>
          <td>${entry.totalDuty}</td>
          <td>${entry.cumulativeDuty}h</td>
          <td>${entry.TETRange}</td>
          <td>${entry.offDuty}</td>
          <td>${entry.violation}</td>
          <td><button onclick="deleteEntry(${i})">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function deleteEntry(index) {
      entries.splice(index, 1);
      entries.forEach((e, i) => e.dayNumber = i + 1);
      renderTable();
    }

    function clearInputs() {
      document.querySelectorAll("input").forEach(i => i.value = "");
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text("NSC Service Hours Report", 14, 14);

      let y = 20;
      entries.forEach((e, i) => {
        const lines = [
          `Day ${e.dayNumber} (${e.date})`,
          `Shift 1: ${e.shift1}`,
          `Shift 2: ${e.shift2}`,
          `OT: ${e.overtime}`,
          `Total Duty: ${e.totalDuty}, TET: ${e.TETRange}`,
          `Split Hours: ${e.splitHours}, Off-Duty: ${e.offDuty}`,
          `Cumulative: ${e.cumulativeDuty}h, Violation: ${e.violation}`
        ];
        lines.forEach(line => {
          doc.text(line, 14, y);
          y += 6;
        });
        y += 4;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save("nsc_hours_report.pdf");
    }
  </script>
</body>
</html>
