<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.07);
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    .form-section {
      margin-bottom: 20px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 15px;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 10px 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px 0 0;
    }
    button:hover {
      background-color: #0056b3;
    }
    .button-group {
      text-align: right;
    }
    table {
      width: 100%;
      margin-top: 25px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      font-size: 0.9em;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .cycle-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>NSC Service Hours Calculator</h2>

    <div class="cycle-toggle">
      <label><b>Select Cycle:</b></label>
      <select id="cycle">
        <option value="1">Cycle 1 (70hr/7 days)</option>
        <option value="2">Cycle 2 (120hr/14 days)</option>
      </select>
    </div>

    <div class="form-section">
      <div class="form-grid">
        <div><label>Date:</label><input type="date" id="date"></div>
      </div>
    </div>

    <div class="form-section">
      <h4>Shift 1</h4>
      <div class="form-grid">
        <div><label>Start Time (e.g., 0530):</label><input type="text" id="shift1Start"></div>
        <div><label>End Time (e.g., 1230):</label><input type="text" id="shift1End"></div>
      </div>
    </div>

    <div class="form-section">
      <h4>Shift 2 (optional)</h4>
      <div class="form-grid">
        <div><label>Start Time:</label><input type="text" id="shift2Start"></div>
        <div><label>End Time:</label><input type="text" id="shift2End"></div>
      </div>
    </div>

    <div class="form-section">
      <h4>Overtime</h4>
      <div class="form-grid">
        <div><label>Before Shift 1 (e.g., 0430 to 0500):</label><input type="text" id="otBeforeTime"></div>
        <div><label>Between Shifts (e.g., 1400 to 1500):</label><input type="text" id="otBetweenTime"></div>
        <div><label>After Shift 2 (e.g., 1900 to 2000):</label><input type="text" id="otAfterTime"></div>
      </div>
    </div>

    <div class="button-group">
      <button onclick="submitDay()">Submit Day</button>
      <button onclick="downloadPDF()">Download PDF</button>
    </div>

    <table id="results">
      <thead>
        <tr>
          <th>Day</th>
          <th>Date</th>
          <th>Shift 1</th>
          <th>Shift 2</th>
          <th>Split Hours</th>
          <th>OT (B/Btwn/A)</th>
          <th>Total Duty</th>
          <th>Cumulative</th>
          <th>TET</th>
          <th>Off-Duty</th>
          <th>Violation</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const entries = [];

    function parseTime(str) {
      if (!str || str.length < 3) return null;
      const hour = parseInt(str.slice(0, 2), 10);
      const min = parseInt(str.slice(2), 10);
      return hour + min / 60;
    }

    function timeDiff(start, end) {
      if (start == null || end == null) return 0;
      return (end - start + 24) % 24;
    }

    function parseOT(str) {
      if (!str.includes("to")) return 0;
      const [start, end] = str.split("to").map(s => s.trim());
      return timeDiff(parseTime(start), parseTime(end));
    }

    function formatTime24To12(time24) {
      const hours = Math.floor(time24) % 24;
      const minutes = Math.round((time24 % 1) * 60);
      const suffix = hours >= 12 ? "PM" : "AM";
      const displayHour = ((hours + 11) % 12 + 1);
      return `${displayHour}:${minutes.toString().padStart(2, "0")} ${suffix}`;
    }

    function formatTimeRange(start, end) {
      if (start == null || end == null) return "-";
      const duration = timeDiff(start, end);
      return `${formatTime24To12(start)} - ${formatTime24To12(end)} (${duration.toFixed(2)}h)`;
    }

    function getCumulative(days) {
      const today = new Date(entries[entries.length - 1].date);
      return entries
        .filter(e => {
          const d = new Date(e.date);
          const diff = (today - d) / (1000 * 60 * 60 * 24);
          return diff <= (days - 1);
        })
        .reduce((sum, e) => sum + e.totalDuty, 0);
    }

    function submitDay() {
      const date = document.getElementById("date").value;
      const shift1Start = parseTime(document.getElementById("shift1Start").value);
      const shift1End = parseTime(document.getElementById("shift1End").value);
      const shift2Start = parseTime(document.getElementById("shift2Start").value);
      const shift2End = parseTime(document.getElementById("shift2End").value);
      const otBefore = parseOT(document.getElementById("otBeforeTime").value);
      const otBetween = parseOT(document.getElementById("otBetweenTime").value);
      const otAfter = parseOT(document.getElementById("otAfterTime").value);
      const cycle = document.getElementById("cycle").value;

      const shift1Hours = timeDiff(shift1Start, shift1End);
      const shift2Hours = timeDiff(shift2Start, shift2End);
      const splitHours = shift2Start ? timeDiff(shift1End, shift2Start) : 0;
      const totalDuty = shift1Hours + shift2Hours + otBefore + otBetween + otAfter;
      const tet = shift2End ? timeDiff(shift1Start, shift2End) : shift1Hours;
      const offDuty = 24 - tet;
      const cumulative = cycle === "1" ? getCumulative(7) + totalDuty : getCumulative(14) + totalDuty;

      const violation = (totalDuty > 14 || tet > 16 || (cycle === "1" && cumulative > 70) || (cycle === "2" && cumulative > 120)) ? "YES" : "";

      entries.push({ date, shift1Start, shift1End, shift2Start, shift2End, splitHours, otBefore, otBetween, otAfter, totalDuty, cumulative, tet, offDuty, violation });

      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector("#results tbody");
      tbody.innerHTML = "";
      entries.forEach((e, i) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${e.date}</td>
          <td>${formatTimeRange(e.shift1Start, e.shift1End)}</td>
          <td>${e.shift2Start ? formatTimeRange(e.shift2Start, e.shift2End) : "-"}</td>
          <td>${e.splitHours.toFixed(2)}</td>
          <td>${e.otBefore.toFixed(2)} / ${e.otBetween.toFixed(2)} / ${e.otAfter.toFixed(2)}</td>
          <td>${e.totalDuty.toFixed(2)}</td>
          <td>${e.cumulative.toFixed(2)}</td>
          <td>${e.tet.toFixed(2)}</td>
          <td>${e.offDuty.toFixed(2)}</td>
          <td>${e.violation}</td>
          <td><button onclick="removeRow(${i})">Delete</button></td>
        `;
      });
    }

    function removeRow(index) {
      entries.splice(index, 1);
      renderTable();
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("NSC Shift Report", 15, 10);
      let y = 20;
      entries.forEach((e, i) => {
        doc.text(
          `${i + 1}. ${e.date} | Duty: ${e.totalDuty.toFixed(2)}h | Cumulative: ${e.cumulative.toFixed(2)}h | Violation: ${e.violation || "No"}`,
          10,
          y
        );
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("NSC_Report.pdf");
    }
  </script>
</body>
</html>
