<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
    h1 { color: #333; }
    label { display: block; margin: 5px 0; }
    input[type="text"] { padding: 5px; width: 150px; }
    button { margin: 10px 5px 0 0; padding: 8px 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #e0e0e0; }
  </style>
</head>
<body>
  <h1>NSC Service Hours Calculator</h1>

  <form id="nscForm">
    <label>Shift 1 Start (e.g. 0500): <input type="text" id="shift1Start" required></label>
    <label>Shift 1 End (e.g. 1300): <input type="text" id="shift1End" required></label>
    <label>Shift 2 Start (optional): <input type="text" id="shift2Start"></label>
    <label>Shift 2 End (optional): <input type="text" id="shift2End"></label>
    <label>Overtime Before Shift 1: <input type="text" id="otBefore"></label>
    <label>Overtime Between Shifts: <input type="text" id="otBetween"></label>
    <label>Overtime After Shift 2: <input type="text" id="otAfter"></label>
    <button type="submit">Submit Day</button>
  </form>

  <table id="results">
    <thead>
      <tr>
        <th>Day</th>
        <th>Shift 1</th>
        <th>Shift 2</th>
        <th>Split Hours</th>
        <th>Overtime (Before / Between / After)</th>
        <th>Total Duty</th>
        <th>TET</th>
        <th>Off-Duty</th>
        <th>NSC Violation</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let currentDay = 1;
    let lastDayEnd = null;
    let totalOffDutyAccumulated = 0;
    let sevenDayWindow = [];

    function timeToMinutes(timeStr) {
      if (!timeStr) return null;
      let time = parseInt(timeStr);
      if (isNaN(time)) return null;
      let hour = Math.floor(time / 100);
      let min = time % 100;
      return hour * 60 + min;
    }

    function minutesToHours(mins) {
      return (mins / 60).toFixed(2);
    }

    function duration(start, end) {
      let s = timeToMinutes(start);
      let e = timeToMinutes(end);
      if (s === null || e === null) return 0;
      if (e < s) e += 1440;
      return e - s;
    }

    function isCycleReset(mins) {
      return mins >= 2160; // 36 hours
    }

    function addRowToTable(day, data) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${day}</td>
        <td>${data.shift1Range} (${minutesToHours(data.shift1Mins)}h)</td>
        <td>${data.shift2Range || "-"} ${data.shift2Mins ? `(${minutesToHours(data.shift2Mins)}h)` : ""}</td>
        <td>${minutesToHours(data.splitMins)}h</td>
        <td>${minutesToHours(data.otBeforeMins)} / ${minutesToHours(data.otBetweenMins)} / ${minutesToHours(data.otAfterMins)} h</td>
        <td>${minutesToHours(data.totalDutyMins)}h</td>
        <td>${minutesToHours(data.tet)}h</td>
        <td>${minutesToHours(data.offDuty)}h</td>
        <td>${data.violation.length ? data.violation.join(", ") : "None"}</td>
        <td><button onclick="this.parentElement.parentElement.remove()">Delete</button></td>
      `;
      document.querySelector('#results tbody').appendChild(row);
    }

    document.getElementById('nscForm').addEventListener('submit', function (event) {
      event.preventDefault();

      const s1s = document.getElementById('shift1Start').value;
      const s1e = document.getElementById('shift1End').value;
      const s2s = document.getElementById('shift2Start').value;
      const s2e = document.getElementById('shift2End').value;
      const ot1 = document.getElementById('otBefore').value;
      const ot2 = document.getElementById('otBetween').value;
      const ot3 = document.getElementById('otAfter').value;

      const shift1Mins = duration(s1s, s1e);
      const shift2Mins = s2s && s2e ? duration(s2s, s2e) : 0;
      const splitMins = s2s ? duration(s1e, s2s) : 0;

      const otBeforeMins = ot1 ? duration(ot1, s1s) : 0;
      const otBetweenMins = ot2 ? duration(s1e, ot2) : 0;
      const otAfterMins = ot3 ? duration(s2e || s1e, ot3) : 0;

      const totalDutyMins = shift1Mins + shift2Mins + otBeforeMins + otBetweenMins + otAfterMins;
      const tet = s2e ? duration(s1s, s2e) : shift1Mins;

      let offDuty = 1440;
      if (lastDayEnd !== null) {
        let startMin = timeToMinutes(s1s);
        if (startMin < lastDayEnd) startMin += 1440;
        offDuty = startMin - lastDayEnd;
        totalOffDutyAccumulated += offDuty;
      }

      if (isCycleReset(totalOffDutyAccumulated)) {
        sevenDayWindow = [];
        totalOffDutyAccumulated = 0;
      }

      let violation = [];
      if (totalDutyMins > 840) violation.push("Over 14h duty");
      if (tet > 960) violation.push("TET over 16h");
      if (offDuty < 480) violation.push("Off-duty <8h");

      sevenDayWindow.push(totalDutyMins / 60);
      if (sevenDayWindow.length > 7) sevenDayWindow.shift();
      const weeklyHours = sevenDayWindow.reduce((a, b) => a + b, 0);
      if (weeklyHours > 70) violation.push(">70h/7days");

      lastDayEnd = timeToMinutes(s2e || s1e);

      const rowData = {
        shift1Range: `${s1s} to ${s1e}`,
        shift2Range: s2s && s2e ? `${s2s} to ${s2e}` : "",
        shift1Mins, shift2Mins, splitMins,
        otBeforeMins, otBetweenMins, otAfterMins,
        totalDutyMins, tet, offDuty, violation
      };

      addRowToTable(currentDay, rowData);
      currentDay++;

      document.getElementById('nscForm').reset();
    });
  </script>
</body>
</html>
