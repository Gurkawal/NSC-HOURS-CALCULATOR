<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    h1 { color: #333; }
    label, input { display: block; margin: 5px 0; }
    input[type="text"] { padding: 5px; width: 150px; }
    button { margin-top: 10px; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #ddd; }
  </style>
</head>
<body>
  <h1>NSC Service Hours Calculator</h1>
  <form id="nscForm">
    <label>Shift 1 Start (e.g., 0500): <input type="text" id="shift1Start"></label>
    <label>Shift 1 End (e.g., 1300): <input type="text" id="shift1End"></label>
    <label>Shift 2 Start (optional): <input type="text" id="shift2Start"></label>
    <label>Shift 2 End (optional): <input type="text" id="shift2End"></label>
    <label>Overtime Before Shift 1 (optional): <input type="text" id="otBefore"></label>
    <label>Overtime Between Shifts (optional): <input type="text" id="otBetween"></label>
    <label>Overtime After Shift 2 (optional): <input type="text" id="otAfter"></label>
    <button type="submit">Submit Day</button>
  </form>

  <table id="results">
    <thead>
      <tr>
        <th>Day</th>
        <th>Shift 1</th>
        <th>Shift 2</th>
        <th>Split Hours</th>
        <th>Overtime (Before / Between / After)</th>
        <th>Total Duty</th>
        <th>TET</th>
        <th>Off-Duty</th>
        <th>NSC Violation</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let previousDayEnd = null;
    let dayCount = 1;
    let sevenDayHours = [];
    let offDutySinceReset = 0;

    function timeToMinutes(t) {
      if (!t) return null;
      t = t.padStart(4, '0');
      const h = parseInt(t.slice(0, 2), 10);
      const m = parseInt(t.slice(2), 10);
      return h * 60 + m;
    }

    function minutesToStr(m) {
      return (m / 60).toFixed(2) + "h";
    }

    function duration(start, end) {
      if (!start || !end) return 0;
      let s = timeToMinutes(start), e = timeToMinutes(end);
      if (e < s) e += 1440;
      return e - s;
    }

    function isCycleReset(offDuty) {
      return offDuty >= 2160; // 36 hours
    }

    function insertRow(day, s1, s2, split, ot, totalDuty, tet, offDuty, violation) {
      const tbody = document.querySelector('#results tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${day}</td>
        <td>${s1}</td>
        <td>${s2 || '-'}</td>
        <td>${split}</td>
        <td>${ot}</td>
        <td>${totalDuty}</td>
        <td>${tet}</td>
        <td>${offDuty}</td>
        <td>${violation || 'None'}</td>
        <td><button onclick="deleteRow(this)">Delete</button></td>
      `;
      tbody.appendChild(row);
    }

    function deleteRow(button) {
      const row = button.parentElement.parentElement;
      row.remove();
      recalculateDayNumbers();
    }

    function recalculateDayNumbers() {
      const rows = document.querySelectorAll('#results tbody tr');
      rows.forEach((row, index) => {
        row.cells[0].innerText = index + 1;
      });
      dayCount = rows.length + 1;
    }

    document.getElementById('nscForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const s1Start = document.getElementById('shift1Start').value;
      const s1End = document.getElementById('shift1End').value;
      const s2Start = document.getElementById('shift2Start').value;
      const s2End = document.getElementById('shift2End').value;
      const otBefore = document.getElementById('otBefore').value;
      const otBetween = document.getElementById('otBetween').value;
      const otAfter = document.getElementById('otAfter').value;

      const s1Min = duration(s1Start, s1End);
      const s2Min = duration(s2Start, s2End);
      const splitMin = s2Start ? duration(s1End, s2Start) : 0;

      const otBeforeMin = otBefore ? duration(otBefore, s1Start) : 0;
      const otBetweenMin = otBetween ? duration(s1End, otBetween) : 0;
      const otAfterMin = otAfter ? duration(s2End || s1End, otAfter) : 0;
      const otTotal = otBeforeMin + otBetweenMin + otAfterMin;

      const totalDutyMin = s1Min + s2Min + otTotal;
      const tetMin = s2End ? duration(s1Start, s2End) : s1Min;

      let startMin = timeToMinutes(s1Start);
      let offDuty = 1440;
      if (previousDayEnd !== null) {
        if (startMin < previousDayEnd) startMin += 1440;
        offDuty = startMin - previousDayEnd;
        offDutySinceReset += offDuty;
      }

      if (isCycleReset(offDutySinceReset)) {
        sevenDayHours = [];
        offDutySinceReset = 0;
      }

      previousDayEnd = timeToMinutes(s2End || s1End);
      sevenDayHours.push(totalDutyMin / 60);
      if (sevenDayHours.length > 7) sevenDayHours.shift();

      let violations = [];
      if (totalDutyMin / 60 > 14) violations.push("Over 14h duty");
      if (tetMin / 60 > 16) violations.push("TET > 16h");
      if (offDuty < 480) violations.push("Off-duty <8h");
      if (sevenDayHours.reduce((a, b) => a + b, 0) > 70) violations.push(">70h in 7d");

      insertRow(
        dayCount++,
        `${s1Start} to ${s1End} (${minutesToStr(s1Min)})`,
        s2Start && s2End ? `${s2Start} to ${s2End} (${minutesToStr(s2Min)})` : '',
        minutesToStr(splitMin),
        `${minutesToStr(otBeforeMin)} / ${minutesToStr(otBetweenMin)} / ${minutesToStr(otAfterMin)}`,
        minutesToStr(totalDutyMin),
        minutesToStr(tetMin),
        minutesToStr(offDuty),
        violations.join(', ')
      );

      document.getElementById('nscForm').reset();
    });
  </script>
</body>
</html>
