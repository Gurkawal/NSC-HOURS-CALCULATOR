<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NSC Hours Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f1f3f5;
      margin: 0;
      padding: 10px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #0056b3;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .section {
      margin-bottom: 20px;
    }
    .group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .group > div {
      flex: 1 1 48%;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      position: sticky;
      bottom: 0;
      background: white;
      padding: 10px 0 0;
      border-top: 1px solid #ddd;
      margin-top: 20px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
    @media (max-width: 600px) {
      .group > div {
        flex: 1 1 100%;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>NSC Service Hours Tracker</h2>

    <div class="section">
      <label for="cycle">Select Cycle</label>
      <select id="cycle">
        <option value="1">Cycle 1 (70hr / 7 days)</option>
        <option value="2">Cycle 2 (120hr / 14 days, 13 max working days)</option>
      </select>
    </div>

    <div class="section group">
      <div>
        <label for="date">Date</label>
        <input type="date" id="date">
      </div>
    </div>

    <div class="section">
      <strong>Shift 1</strong>
      <div class="group">
        <div><label>Start Time</label><input type="text" id="shift1Start" placeholder="e.g., 0530"></div>
        <div><label>End Time</label><input type="text" id="shift1End" placeholder="e.g., 1230"></div>
      </div>
    </div>

    <div class="section">
      <strong>Shift 2 (Optional)</strong>
      <div class="group">
        <div><label>Start Time</label><input type="text" id="shift2Start"></div>
        <div><label>End Time</label><input type="text" id="shift2End"></div>
      </div>
    </div>

    <div class="section">
      <strong>Overtime</strong>
      <div class="group">
        <div><label>Before Shift 1</label><input type="text" id="otBeforeTime" placeholder="0430 to 0500"></div>
        <div><label>Between Shifts</label><input type="text" id="otBetweenTime" placeholder="1400 to 1500"></div>
        <div><label>After Shift 2</label><input type="text" id="otAfterTime" placeholder="1900 to 2000"></div>
      </div>
    </div>

    <div class="buttons">
      <button onclick="submitDay()">Submit Day</button>
      <button onclick="downloadPDF()">Download PDF</button>
    </div>

    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Shift 1</th>
          <th>Shift 2</th>
          <th>OT (B/Btwn/A)</th>
          <th>Duty</th>
          <th>Cumulative</th>
          <th>TET</th>
          <th>Off-Duty</th>
          <th>Violation</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const entries = [];

    function parseTime(str) {
      if (!str || str.length < 3) return null;
      const hour = parseInt(str.slice(0, 2), 10);
      const min = parseInt(str.slice(2), 10);
      return hour + min / 60;
    }

    function timeDiff(start, end) {
      if (start == null || end == null) return 0;
      return (end - start + 24) % 24;
    }

    function parseOT(str) {
      if (!str.includes("to")) return 0;
      const [start, end] = str.split("to").map(s => s.trim());
      return timeDiff(parseTime(start), parseTime(end));
    }

    function formatTime24To12(time24) {
      const hours = Math.floor(time24) % 24;
      const minutes = Math.round((time24 % 1) * 60);
      const suffix = hours >= 12 ? "PM" : "AM";
      const displayHour = ((hours + 11) % 12 + 1);
      return `${displayHour}:${minutes.toString().padStart(2, "0")} ${suffix}`;
    }

    function formatTimeRange(start, end) {
      if (start == null || end == null) return "-";
      const duration = timeDiff(start, end);
      return `${formatTime24To12(start)} - ${formatTime24To12(end)} (${duration.toFixed(2)}h)`;
    }

    function getCumulative(days) {
      const today = new Date(entries[entries.length - 1].date);
      return entries
        .filter(e => {
          const d = new Date(e.date);
          const diff = (today - d) / (1000 * 60 * 60 * 24);
          return diff <= (days - 1);
        })
        .reduce((sum, e) => sum + e.totalDuty, 0);
    }

    function getConsecutiveWorkDays() {
      const sorted = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
      let count = 1;
      for (let i = sorted.length - 2; i >= 0; i--) {
        const d1 = new Date(sorted[i + 1].date);
        const d2 = new Date(sorted[i].date);
        if ((d1 - d2) / (1000 * 60 * 60 * 24) === 1) count++;
        else break;
      }
      return count;
    }

    function submitDay() {
      const date = document.getElementById("date").value;
      const shift1Start = parseTime(document.getElementById("shift1Start").value);
      const shift1End = parseTime(document.getElementById("shift1End").value);
      const shift2Start = parseTime(document.getElementById("shift2Start").value);
      const shift2End = parseTime(document.getElementById("shift2End").value);
      const otBefore = parseOT(document.getElementById("otBeforeTime").value);
      const otBetween = parseOT(document.getElementById("otBetweenTime").value);
      const otAfter = parseOT(document.getElementById("otAfterTime").value);
      const cycle = document.getElementById("cycle").value;

      const shift1Hours = timeDiff(shift1Start, shift1End);
      const shift2Hours = timeDiff(shift2Start, shift2End);
      const totalDuty = shift1Hours + shift2Hours + otBefore + otBetween + otAfter;
      const tet = shift2End ? timeDiff(shift1Start, shift2End) : shift1Hours;
      const offDuty = 24 - tet;
      const cumulative = cycle === "1" ? getCumulative(7) + totalDuty : getCumulative(14) + totalDuty;

      let violation = "";
      if (totalDuty > 14 || tet > 16) violation = "Duty Limit";
      else if (cycle === "1" && cumulative > 70) violation = "Cycle 1 Limit";
      else if (cycle === "2" && cumulative > 120) violation = "Cycle 2 Limit";
      else if (cycle === "2" && getConsecutiveWorkDays() >= 13) violation = "Must Take Day Off";

      entries.push({ date, shift1Start, shift1End, shift2Start, shift2End, otBefore, otBetween, otAfter, totalDuty, cumulative, tet, offDuty, violation });
      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector("#results tbody");
      tbody.innerHTML = "";
      entries.forEach((e, i) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${e.date}</td>
          <td>${formatTimeRange(e.shift1Start, e.shift1End)}</td>
          <td>${e.shift2Start ? formatTimeRange(e.shift2Start, e.shift2End) : "-"}</td>
          <td>${e.otBefore.toFixed(2)} / ${e.otBetween.toFixed(2)} / ${e.otAfter.toFixed(2)}</td>
          <td>${e.totalDuty.toFixed(2)}</td>
          <td>${e.cumulative.toFixed(2)}</td>
          <td>${e.tet.toFixed(2)}</td>
          <td>${e.offDuty.toFixed(2)}</td>
          <td>${e.violation}</td>
          <td><button onclick="removeRow(${i})">Delete</button></td>
        `;
      });
    }

    function removeRow(index) {
      entries.splice(index, 1);
      renderTable();
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("NSC Shift Report", 15, 10);
      let y = 20;
      entries.forEach((e, i) => {
        doc.text(
          `${i + 1}. ${e.date} | Duty: ${e.totalDuty.toFixed(2)}h | Cumulative: ${e.cumulative.toFixed(2)}h | Violation: ${e.violation || "No"}`,
          10,
          y
        );
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("NSC_Report.pdf");
    }
  </script>
</body>
</html>
