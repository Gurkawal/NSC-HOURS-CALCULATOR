<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8">
  <title>NSC Service Hours Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    h1 { color: #333; }
    label, input { display: block; margin: 5px 0; }
    input[type="text"] { padding: 5px; width: 150px; }
    button { margin-top: 10px; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #ddd; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>NSC Service Hours Calculator</h1>
  <form id="nscForm">
    <label>Shift 1 Start (e.g., 0500): <input type="text" id="shift1Start"></label>
    <label>Shift 1 End (e.g., 1300): <input type="text" id="shift1End"></label>
    <label>Shift 2 Start (optional): <input type="text" id="shift2Start"></label>
    <label>Shift 2 End (optional): <input type="text" id="shift2End"></label>
    <label>Overtime Before Shift 1 (optional): <input type="text" id="otBefore"></label>
    <label>Overtime Between Shifts (optional): <input type="text" id="otBetween"></label>
    <label>Overtime After Shift 2 (optional): <input type="text" id="otAfter"></label>
    <button type="submit">Submit Day</button>
  </form><button onclick="downloadPDF()">Download PDF</button>

  <table id="results">
    <thead>
      <tr>
        <th>Day</th>
        <th>Shift 1 Hours</th>
        <th>Shift 2 Hours</th>
        <th>Split Hours</th>
        <th>Overtime Total</th>
        <th>Total Duty Hours</th>
        <th>TET</th>
        <th>Off-Duty Hours</th>
        <th>NSC Violation</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>  <script>
    let lastDayEnd = null;
    let currentDay = 1;
    let sevenDayWindow = [];

    function timeToMinutes(timeStr) {
      if (!timeStr) return null;
      let time = parseInt(timeStr);
      let hour = Math.floor(time / 100);
      let minutes = time % 100;
      return hour * 60 + minutes;
    }

    function minutesToHours(mins) {
      return (mins / 60).toFixed(2);
    }

    function duration(start, end) {
      if (start === null || end === null) return 0;
      if (end < start) end += 2400;
      let s = timeToMinutes(start);
      let e = timeToMinutes(end);
      if (e < s) e += 1440;
      return e - s;
    }

    document.getElementById('nscForm').addEventListener('submit', function(event) {
      event.preventDefault();
      let s1s = document.getElementById('shift1Start').value;
      let s1e = document.getElementById('shift1End').value;
      let s2s = document.getElementById('shift2Start').value;
      let s2e = document.getElementById('shift2End').value;
      let ot1 = document.getElementById('otBefore').value;
      let ot2 = document.getElementById('otBetween').value;
      let ot3 = document.getElementById('otAfter').value;

      let shift1Mins = duration(s1s, s1e);
      let shift2Mins = s2s && s2e ? duration(s2s, s2e) : 0;
      let splitMins = s2s ? duration(s1e, s2s) : 0;
      let otMins = duration(ot1, s1s) + duration(s1e, ot2) + duration(s2e || s1e, ot3);
      let totalDutyMins = shift1Mins + shift2Mins + otMins;
      let tet = s2e ? duration(s1s, s2e) : shift1Mins;

      let offDuty = 1440;
      if (lastDayEnd !== null) {
        let startMin = timeToMinutes(s1s);
        if (startMin < lastDayEnd) startMin += 1440;
        offDuty = startMin - lastDayEnd;
      }

      if (lastDayEnd === null || offDuty >= 480) {
        currentDay++;
      }

      let violation = [];
      if (totalDutyMins / 60 > 14) violation.push("Over 14h duty");
      if ((shift1Mins + shift2Mins) / 60 > 13) violation.push("Over 13h driving");
      if (tet / 60 > 16) violation.push("TET over 16h");
      if (offDuty < 480) violation.push("<8h off-duty");

      lastDayEnd = timeToMinutes(s2e || s1e);
      sevenDayWindow.push(totalDutyMins / 60);
      if (sevenDayWindow.length > 7) sevenDayWindow.shift();
      if (sevenDayWindow.reduce((a, b) => a + b, 0) > 70) violation.push(">70h in 7 days");

      let row = `<tr>
        <td>${currentDay - 1}</td>
        <td>${minutesToHours(shift1Mins)}</td>
        <td>${minutesToHours(shift2Mins)}</td>
        <td>${minutesToHours(splitMins)}</td>
        <td>${minutesToHours(otMins)}</td>
        <td>${minutesToHours(totalDutyMins)}</td>
        <td>${minutesToHours(tet)}</td>
        <td>${minutesToHours(offDuty)}</td>
        <td>${violation.length ? violation.join(", ") : "None"}</td>
      </tr>`;

      document.querySelector('#results tbody').insertAdjacentHTML('beforeend', row);
      document.getElementById('nscForm').reset();
    });

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const table = document.getElementById("results");
      const canvas = await html2canvas(table);
      const imgData = canvas.toDataURL("image/png");
      const imgProps = doc.getImageProperties(imgData);
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      doc.text("NSC Service Hours Log", 10, 10);
      doc.addImage(imgData, "PNG", 10, 20, pdfWidth - 20, pdfHeight);
      doc.save("NSC_Service_Hours.pdf");
    }
  </script></body>
</html>
